---
title: "J1798 PDAC trial - Correlation of Luminex with response"
author: "Ludmila Danilova"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,
                      warning = FALSE)
rm(list = ls())

library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(data.table)
library("DT")
library(gridExtra)
library(scales)
library(readxl)
library(xlsx)
library(pheatmap)

# set root folder
rootDir = "C:/Users/Luda/OneDrive - Johns Hopkins/J1798/"

source(paste0(rootDir,"Scripts/parameters_and_functions.r"))

```


```{r echo=FALSE,  fig.width = 10}
# Load patient data
sampAnnot <- as.data.frame(read_excel(paste0(rootDir,"/Data/Clinical_info/J1798 annotation file for correlative analyses_de-identified.xlsx"), sheet = "PDAC Patients"))

sampAnnot <- sampAnnot[!is.na(sampAnnot$SampleID),]
# split sample ID into number ID and letter ID
sampID = t(as.data.frame(strsplit(sampAnnot$SampleID, " ", fixed = T)))
colnames(sampID) = c("numberID","letterID")
sampAnnot = cbind(sampID, sampAnnot)

# remove duplications
patAnnot = sampAnnot[!duplicated(sampAnnot$numberID),]
rownames(patAnnot) = paste0("J",patAnnot$numberID)
patAnnot = patAnnot[,setdiff(colnames(patAnnot),c("TIME_ID", "Bx Timepoint"))]

#sampAnnot$SampleID <- gsub("-","_", sampAnnot$SampleID)

# create RECIST and CBR responses
patAnnot = patAnnot %>% 
  mutate(RECIST = factor(`Best response (per RECIST v1.1)`, levels = c("Responder", "NonResponder"), labels = c("R","NR"))) %>%
  mutate(CBR = factor(`Overall Clinical Benefit (PR+SD vs PD)`, levels = c("Responder", "NonResponder"), labels = c("R","NR")))


#==========================
# load Luminex data
lumFile = paste0(rootDir,"Data/Cytokines/LUM_Azad_48-plex_results_03-21-23.xlsx")
#==
# read ranges of detection
ranges = as.data.frame(read_xlsx(lumFile, 1, skip = 1, n_max = 3, trim_ws = T))
# remove empty columns
ranges = ranges[, !is.na(ranges[1,])]

#==
# read cytokine units
cytokines = t(as.data.frame(read_excel(lumFile, 1, skip = 5, n_max = 2)))
cytokines = cytokines[!is.na(cytokines[,1]),]
cytokines = cytokines[!is.na(cytokines[,2]),]
rownames(cytokines) = cytokines[,2]
# add range of detection
cytokines = cbind(cytokines, lower_limit = t(ranges[1,rownames(cytokines)]),
                  upper_limit = t(ranges[2,rownames(cytokines)]))
colnames(cytokines) = c("unit","cytokine", "lower_limit","upper_limit")

#==
# read cytokine values
dat = as.data.frame(read_excel(lumFile, 1, skip = 7))
dat = dat[!is.na(dat[,2]), ]
# fix mislabeled sample
s = grep(' Should be "026"', dat[,2])
dat[s,2] = gsub("J1798.025", "J1798.026", dat[s,2])
# fix ID for the first sample MJ
dat[,2] = gsub(" MJ", ".001", dat[,2])

#==========================
# replace OOR with lower/high values from the range
for( i in rownames(cytokines))
{
  # replace with lower detection boundary
  dat[,i] = gsub("OOR <",ranges[1,i],dat[,i])
  # replace with upper detection boundary
  dat[,i] = gsub("OOR >",ranges[2,i],dat[,i])
  # round
  dat[,i] = round(as.numeric(dat[,i]), 3)
}

#=======
# extract sample IDs and time points, add patient info and combine with data
s = strsplit(dat[,2], " ", fixed = T)
samp = data.frame(patientID = sapply(s, geti, 1), timePoint = sapply(s, geti, 2))
samp$patientID = gsub('.',"-", samp$patientID, fixed = T)
# and unify timepoints
samp = samp %>% 
  mutate(timePoint = factor(timePoint, 
  levels = c("Baseline","Day-14","D-14", "C1D1", "PreC1D1", "Pre-C1D1", "Week"),
  labels = c(timeLab[1],timeLab[1],timeLab[1],timeLab[2], timeLab[2], timeLab[2], timeLab[3])))

# add to data
dat = cbind(samp, dat, patAnnot[samp$patientID, ])

rownames(dat) = paste(dat$`Publication  ID`,dat$timePoint, sep = '_')
rownames(dat) = gsub(" ","_", rownames(dat), fixed = T)

#==============
# print the number of samples per time point
print(table(dat$timePoint))

#===========
# Save data for the supplementary table
write.csv(dat[,c("Publication  ID", "timePoint", rownames(cytokines))], 
          file =paste0(rootDir,"for_paper/table_cytokine_values.csv"), quote = F, row.names = F) 
write.csv(cytokines[,c("cytokine", "unit","lower_limit","upper_limit")], 
          file =paste0(rootDir,"for_paper/table_cytokine_panel.csv"), quote = F, row.names = F) 

```


## Heatmap

```{r echo=FALSE,  fig.width = 10, fig.height=10}

pheatmap(t(log10(dat[, cytokines[,2]]+1)), scale = "column", annotation_col = dat[,c("RECIST", "timePoint")], annotation_colors = list(RECIST = recistCol, timePoint = timeCol))

ord = order(dat$timePoint, dat$RECIST)

pheatmap(t(log10(dat[ord, cytokines[,2]]+1)), scale = "column", annotation_col = dat[,c("RECIST", "timePoint")], annotation_colors = list(RECIST = recistCol, timePoint = timeCol), cluster_cols = F)


```

## Cytokines by RECIST over time

### Table 

paired Wilcoxon p-values for time points.
And unpaired Wilcoxon test comparing responders vs non-responders at baseline and C1D1 (columns B_RvsNR and C1D11_RvsNR). C2D1 doesn't have enough samples to test.

```{r echo=FALSE,  fig.width = 10}

# create table with descriptive statistics for responders and non-responders and p-values

# tab = sapply(cytokines[,2], function(i){
#   df = data.frame(protein = dat[,i],dat[,c("timePoint","RECIST")]) 
#   # responders
#   resp = df %>% filter(RECIST == "R" & timePoint == timeLab[1]) %>% select(protein) %>% unlist()
#   resp1 = df %>% filter(RECIST == "R" & timePoint == timeLab[2]) %>% select(protein) %>% unlist()
#   resp2 = df %>% filter(RECIST == "R" & timePoint == timeLab[3]) %>% select(protein) %>% unlist()
#   # non-responders
#   nresp = df %>% filter(RECIST == "NR" & timePoint == timeLab[1])%>% select(protein)%>% unlist()
#   nresp1 = df %>% filter(RECIST == "NR" & timePoint == timeLab[2])%>% select(protein)%>% unlist()
#   nresp2 = df %>% filter(RECIST == "NR" & timePoint == timeLab[3])%>% select(protein)%>% unlist()
# 
#   # p-values
#    res = compare_means(protein ~ RECIST, df, group.by = "timePoint")
#    
#  c(baseline_mean_resp = round(mean(resp, na.rm = T),2),
#    baseline_mean_non_resp = round(mean(nresp, na.rm = T),2),
#    baseline_p_value = res[1,'p.format'], 
#    
#    timepoint1_mean_resp = round(mean(resp1, na.rm = T),2),
#    timepoint1_mean_non_resp = round(mean(nresp1, na.rm = T),2),
#    timepoint1_p_value = res[2,'p.format'],
#    
#    timepoint2_mean_resp = round(mean(resp2, na.rm = T),2),
#    timepoint2_mean_non_resp = round(mean(nresp2, na.rm = T),2),
#    timepoint2_p_value = res[3,'p.format']) 
# 
# })
# 
# tab = t(tab)
# colnames(tab) = gsub(".p.format","", colnames(tab))
# 

# datatable(tab)
# reformat table for the supplement
# tab1 = cbind(cytokines[,c(2,1)], tab)
# write.csv(tab1, row.names = F, file = paste0(rootDir,"Results/Cytokines/table_cytokines_by_response.csv"))



res = c()
  for (k in cytokines[,2])
  {
    mat <- data.frame(matrix(nrow = length(unique(dat$patientID)),
      ncol = 3, dimnames = list(unique(dat$patientID),
                      levels(factor(dat$timePoint)))), check.names = F)
    for(i in levels(factor(dat$timePoint)))
    {
      d1 = dat %>% filter(timePoint == i)
      mat[d1$patientID, i] = d1[,k]
    }
    # add response
    mat$RECIST = patAnnot[rownames(mat),"RECIST"]
    # create treatment effect 
    # substract baseline from post run-in and week 8 
    mat$delta_T1_B =  mat[,2]-mat[,1]
    mat$delta_T2_B =  mat[,3]-mat[,1]
    # and week 8 from post run-in 
    mat$delta_T2_T1 =  mat[,3]-mat[,2]
    
    # running paired test
    # Baseline vs post run-in
    p1 = wilcox.test(mat[,1], mat[,2], paired = T)$p.value
    # post run-in vs week 8
    p2 = wilcox.test(mat[,2], mat[,3], paired = T)$p.value
    # Baseline vs week 8
    p3 = wilcox.test(mat[,1], mat[,3], paired = T)$p.value
    
    # test by response
    # for baseline 
    p4 = wilcox.test(Baseline ~ RECIST, data = mat)$p.value
    # for post run-in 
    p5 = wilcox.test(mat[,2] ~ mat[,"RECIST"], data = mat)$p.value

       
    res = rbind(res, c(BvsC1D1 = p1,C1D1vsC2D1 = p2, BvsC1D1 = p3, B_RvsNR = p4, C1D1_RvsNR = p5))
  }

rownames(res) = cytokines[,2]
res = round(res,3)
write.csv(cbind(cytokines[,2],res), row.names = F, file = paste0(rootDir,"Results/Cytokines/table_cytokine_wilcox_pvalues.csv"))

datatable(res)


```

### Paired boxplots by time and RECIST

NB! The paired Wilcoxon test p-values p-values are in the table above

```{r echo=FALSE, fig.width= 4, fig.height= 3}


for(i in cytokines[,2])
{
  df = cbind(protein = dat[,i], dat[,c("patientID", "timePoint", "RECIST") ] )
  print(i)
    print(ggpaired(df , x="timePoint",y="protein", id = "patientID", line.size = .7, line.color = "RECIST",palette =  recistCol,
     title = "", xlab="Time point", ylab = paste(i,"(",cytokines[i,1],")")) +
       theme(legend.position="right") +
      scale_x_discrete(labels=timeLab)+
      scale_y_continuous(trans = "log10", labels = comma))
}



```

### Boxplots of all samples by RECIST and time point

```{r echo=FALSE,  fig.width = 10}

##RECIST (Responders vs. Nonresponders)
for(i in cytokines[,2])
{
  df = cbind(protein = dat[,i], dat[,c("RECIST","timePoint") ] )
print(ggplot(df, aes(x=RECIST, y=protein)) +
  geom_boxplot() +
  labs(title=paste0(i,". All Samples")) +
  ylab(paste(i,"(",cytokines[i,1],")"))+
  stat_compare_means(method = "wilcox.test") +
  geom_point() +
  scale_y_log10()+
  facet_wrap("timePoint")+
  theme_bw())
}

```


```{r echo=FALSE}
sessionInfo()
```




